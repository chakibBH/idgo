{% load bootstrap3 %}

{% if messages %}
	{% for message in messages %}
		{% if message.tags == 'success' %}
		<div class="alert alert-success" role="alert">{{ message | escape | safe }}</div>
		{% elif message.tags == 'error' %}
		<div class="alert alert-danger" role="alert">{{ message | escape | safe }}</div>
		{% endif %}
		{% endfor %}
{% endif %}

<form name="dataset" method="post" action="">
	{% csrf_token %}
	<div class="row">
		<div class="col-xs-12">
			{% bootstrap_field form.name %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			{% bootstrap_field form.description %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			{% bootstrap_field form.keywords %}
		</div>
	</div>
	<div class="form-group">
		<label for="categories">Catégories (sélectionnez dans la liste ci-dessous une ou plusieurs catégories)</label></br>
		<div id="categories" class="btn-group" data-toggle="buttons">
			{% for category in form.categories %}
			<label for="{{ category.id_for_label }}" class="btn">
				{{ category.tag }}
				<span class="badge">{{ category.choice_label }}</span>
			</label>
			{% empty %}
			<p>Aucune catégorie n'est disponible.</p>
			{% endfor %}
		</div>
	</div>
	<hr />
	<div class="row">
		<div class="col-xs-3">
			{% bootstrap_field form.date_creation %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-3">
			{% bootstrap_field form.date_modification %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-3">
			{% bootstrap_field form.date_publication %}
		</div>
	</div>
	<hr />
	<div class="row">
		<div class="col-xs-4">
			{% bootstrap_field form.update_freq %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-4">
			{% bootstrap_field form.geocover %}
		</div>
	</div>
	<hr />
	<div class="row">
		<div class="col-xs-8">
			{% bootstrap_field form.organisation %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-8">
			{% bootstrap_field form.licences %}
		</div>
	</div>
	<!-- <div class="row">
		<div class="col-xs-4">
			{# {% bootstrap_field form.owner_email %} #}
		</div>
	</div> -->
	<div class="row">
		<div class="col-xs-12">
			{% bootstrap_field form.published %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			{% bootstrap_field form.is_inspire %}
		</div>
	</div>
	<br />
	<div class="row">
		<div class="col-xs-12">
			<p>* Les champs marqués d'un astérisque sont obligatoires.</p>
		</div>
	</div>
	<div class="buttons-on-the-right-side">
		<button type="submit" name="save" class="btn btn-primary">Enregistrer</button>
		<a class="btn btn-default" href="{% url "idgo_admin:home" %}">Revenir</a>
	</div>
</form>
<script>

var LICENSES = {{ licenses }};
// TODO récupérer les 'id' dynamiquements..
$('#id_organisation').change(function() {
	$('#id_licences').val(LICENSES[$(this).val()]);
});

$('.datepicker').datepicker();

$('form[name="dataset"] input[checked=""], form[name="dataset"] input[checked="checked"]').each(function() {
	$('label[for="' + this.id + '"]').addClass('active');
});

function extractor(query) {
	var result = /([^,]+)$/.exec(query);
	if (result && result[1]) {
		return result[1].trim();
	};
	return '';
};

$('#dataset .typeahead').typeahead({
	source: {{ tags | safe }},
	updater: function(item) {
		return this.$element.val().replace(/[^,\s]*$/, '') + item + ', ';
	},
	matcher: function (item) {
		var query = extractor(this.query);
		if (!query) {
			return false;
		};
		return ~item.toLowerCase().indexOf(query.toLowerCase())
	},
	highlighter: function (item) {
		var query = extractor(this.query).replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&')
		return item.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
			return '<strong>' + match + '</strong>';
		});
	}
});

// $('#dataset .typeahead').tagsinput({
// 	typeahead: {
// 		source: {{ tags | safe }}
// 	},
// 	freeInput: true,
// 	tagClass: 'badge'
// });

</script>
