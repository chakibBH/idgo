<div id="datasets-filter" class="well">
	<div class="row">
		<div class="col-sm-offset-6 col-sm-6">
			<div class="input-group">
				<input name="dataset" type="text" class="typeahead form-control" placeholder="Trouver un jeu de données ou rechercher par texte libre" data-provide="typeahead"></input>
				<span class="input-group-btn">
					<button class="btn btn-default" type="button" name="clear">
						<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
					</button>
				</span>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-offset-6 col-sm-6">
			<div class="input-group">
				<input name="organisation" type="text" class="typeahead form-control" placeholder="Organisation" data-provide="typeahead"></input>
				<span class="input-group-btn">
					<button class="btn btn-default" type="button" name="clear">
						<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
					</button>
				</span>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-offset-6 col-sm-6">
			<div class="input-group">
				<select name="category" type="text" class="form-control">
					<option disabled>Catégorie</option>
				{% for category in all_categories %}
					<option value="{{ category.id }}">{{ category.name }}</option>
				{% endfor %}
				</select>
				<span class="input-group-btn">
					<button class="btn btn-default" type="button" name="clear">
						<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
					</button>
				</span>
			</div>
		</div>
	</div>
	<div class="form-group">
		<div class="row">
			<div class="col-sm-offset-6 col-sm-6">
				<div class="checkbox">
					<label>
						<input name="private" type="checkbox"> Le jeu de données est privé
					</label>
				</div>
			</div>
		</div>
	</div>
	<div class="collapse" id="more-filter-criteria">
		<hr />
		<div class="row">
			<div class="col-sm-offset-6 col-sm-6">
				<div class="form-group">
					<div class="checkbox">
						<label>
							<input name="sync" type="checkbox"> Au moins une ressource est synchronisée
						</label>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-offset-6 col-sm-6">
				<div class="input-group">
					<select name="syncfrequency" type="text" class="form-control">
						<option disabled>Fréquence de synchronisation</option>
					{% for update_frequency in all_update_frequencies %}
						<option value="{{ update_frequency.id }}">{{ update_frequency.name }}</option>
					{% endfor %}
					</select>
					<span class="input-group-btn">
						<button class="btn btn-default" type="button" name="clear">
							<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
						</button>
					</span>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-offset-6 col-sm-6">
				<div class="input-group">
					<select name="license" type="text" class="form-control">
						<option disabled>Licence</option>
					{% for license in all_licenses %}
						<option value="{{ license.id }}">{{ license.name }}</option>
					{% endfor %}
					</select>
					<span class="input-group-btn">
						<button class="btn btn-default" type="button" name="clear">
							<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
						</button>
					</span>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-offset-6 col-sm-6">
				<div class="input-group">
					<select name="resourceformat" type="text" class="form-control">
						<option disabled>Format de ressource</option>
					{% for resourceformat in all_resourceformats %}
						<option value="{{ resourceformat.id }}">{{ resourceformat.name }}</option>
					{% endfor %}
					</select>
					<span class="input-group-btn">
						<button class="btn btn-default" type="button" name="clear">
							<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
						</button>
					</span>
				</div>
			</div>
		</div>
		<br />
	</div>
	<div class="buttons-on-the-right-side">
		<button role="button" name="more-filter-criteria" class="btn btn-default" data-toggle="collapse" href="#more-filter-criteria">Plus de critères</button>
		<button role="button" name="clear-all" class="btn btn-default">Réinitialiser</button>
		<button role="button" name="submit" class="btn btn-default">Rechercher</button>
	</div>
</div>
<script>
$(function() {
	var qs = {};
	const $div = $('#datasets-filter');

	$div.find('button[name="clear"]').popover({
		'trigger': 'hover',
		'content': 'Effacer'
	});

	const getQueryVariable = function(variable) {
		var query = window.location.search.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			var pair = vars[i].split('=');
			if (decodeURIComponent(pair[0]) == variable) {
				return decodeURIComponent(pair[1]);
			};
		};
	};

	$div.find('input.typeahead[name="dataset"]')
		// Recherche libre et filtre strict sur jeu de données
		.on('input', function() {
			qs['q'] = this.value;
		})
		.typeahead({
			source: (function() {
				var arr = [];
				{% for item in all_datasets %}
				arr.push({'id': '{{ item.id }}', 'name': '{{ item.name }}'});
				{% endfor %}
				return arr;
			})(),
			autoSelect: false,
			fitToElement: false,
			afterSelect: function(val) {
				qs['dataset'] = val.id;
			}
		})
		.val(getQueryVariable('q'));

	$div.find('input.typeahead[name="organisation"]')
		// Recherche strict sur organisation
		.on('input', function() {
			qs['organisation'] = this.value;
		})
		.typeahead({
			source: (function() {
				var arr = [];
				{% for item in all_organisations %}
				arr.push({'id': '{{ item.id }}', 'name': '{{ item.name }}'});
				{% endfor %}
				return arr;
			})(),
			autoSelect: true,
			fitToElement: true,
			afterSelect: function(val) {
				qs['organisation'] = val.id;
			}
		})
		.typeahead('selectBy', 'id', getQueryVariable('organisation'));

	const $selectCategory = $div.find('select[name="category"]')
		// Recherche strict sur catégorie
		.on('change', function() {
			qs['category'] = this.value;
		});
	$selectCategory.val(getQueryVariable('category') || $selectCategory.find('option:first').val());

	$div.find('input[name="private"]')
		// Recherche strict sur le statut de publication des jeux de données
		.on('change', function() {
			qs['private'] = $(this).prop('checked');
		}).prop('checked', getQueryVariable('private') == 'true' ? true : false)

	const $selectSyncFrequency = $div.find('select[name="syncfrequency"]')
		// Recherche strict sur fréquence de synchronisation
		// ..nécessite de cocher le checkbox `input[name="sync"]`
				.on('change', function() {
			qs['syncfrequency'] = this.value;
		});
	$selectSyncFrequency.val(getQueryVariable('syncfrequency') || $selectSyncFrequency.find('option:first').val());

	$div.find('input[name="sync"]')
		// Recherche strict sur les jeux de données qui ont au moins une ressource synchronisée
		// ..active `select[name="syncfrequency"]`
		.on('change', function() {
			const checked = $(this).prop('checked')
			qs['sync'] = checked;
			if (checked) {
				$selectSyncFrequency.removeClass('disabled').prop('disabled', false);
			} else {
				$selectSyncFrequency.addClass('disabled').prop('disabled', true);
				$selectSyncFrequency.val($selectSyncFrequency.find('option:first').val());
			};
		})
		.prop('checked', getQueryVariable('sync') == 'true' ? true : false)
		.trigger('change');

	const $selectLicense = $div.find('select[name="license"]')
		// Recherche strict sur licence
		.on('change', function() {
			qs['license'] = this.value;
		});
	$selectLicense.val(getQueryVariable('license') || $selectLicense.find('option:first').val());

	const $selectResourceFormat = $div.find('select[name="resourceformat"]')
		// Recherche strict sur un format de ressource
		.on('change', function() {
			qs['resourceformat'] = this.value;
		});
	$selectResourceFormat.val(getQueryVariable('resourceformat') || $selectResourceFormat.find('option:first').val());

	const clear = function($target) {
		$target.is('input[type="checkbox"]') && $target.prop('checked', false);
		$target.is('input[type="text"]') && $target.val('');
		$target.is('select') && $target.val($target.find('option:first').val());
		qs = {};
		$submit.trigger('click');
	};

	$div.find('button[name="clear"]').click(function(e) {
		e.preventDefault();
		clear($(this).parent().siblings('input, select'));
	});

	$div.find('button[name="clear-all"]').click(function(e) {
		e.preventDefault();
		$div.find('input, select').each(function(i) {
			clear($(this));
		});
	});

	const $moreFilterCriteria = $('#more-filter-criteria').collapse()
		// TODO Renommer le bouton `collapse`
		.on('hide.bs.collapse', function() {
			// Fermer le `collapse` réinitialise les critères optionnels
			$(this).find('input, select').each(function(i) {
				clear($(this));
			});
		});

	const $submit = $div.find('button[name="submit"]')
		.click(function(e) {
			e.preventDefault();
			var kvp = [];
			for (k in qs) {
				const k_ = encodeURI(k);
				const v_ = encodeURI(qs[k]);
				kvp = window.location.search.substr(1).split('&');
				var i = kvp.length; var x; while (i--) {
					x = kvp[i].split('=');
					if (x[0] == k_) {
						x[1] = v_;
						kvp[i] = x.join('=');
						break;
					};
				};
				if (i < 0) {
					kvp[kvp.length] = [k_, v_].join('=');
				};
			};
			window.location.search = kvp.join('&');
		});
});
</script>
