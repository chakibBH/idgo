<div id="datasets-filter" class="well">
	<div class="input-group">
		<input name="dataset" type="text" class="typeahead form-control" placeholder="Recherche libre" data-provide="typeahead"></input>
		<span class="input-group-btn">
			<button class="btn btn-default" type="button" name="clear">
				<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
			</button>
		</span>
	</div>
	<div class="row">
		<div class="col-xs-6">
			<div class="input-group">
				<input name="organisation" type="text" class="typeahead form-control" placeholder="Sélectionner une organisation" data-provide="typeahead"></input>
				<span class="input-group-btn">
					<button class="btn btn-default" type="button" name="clear">
						<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
					</button>
				</span>
			</div>
		</div>
		<div class="col-xs-6">
			<div class="input-group">
				<select name="category" type="text" class="form-control">
					<option disabled>Sélectionnez une catégorie</option>
				{% for category in all_categories %}
					<option value="{{ category.id }}">{{ category.name }}</option>
				{% endfor %}
				</select>
				<span class="input-group-btn">
					<button class="btn btn-default" type="button" name="clear">
						<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
					</button>
				</span>
			</div>
		</div>
	</div>
	<div class="form-group">
		<div class="checkbox">
			<label>
				<input name="published" type="checkbox"> Le jeu de données est publié
			</label>
		</div>
	</div>
	<div class="buttons-on-the-right-side">
		<button role="button" name="clear-all" class="btn btn-default">Réinitialiser</button>
		<button role="button" name="submit" class="btn btn-default">Rechercher</button>
	</div>
</div>

<script>
$(function() {
	var qs = {};
	const $div = $('#datasets-filter');

	$div.find('button[name="clear"]').popover({
		'trigger': 'hover',
		'content': 'Effacer'
	});

	const getQueryVariable = function(variable) {
		var query = window.location.search.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			var pair = vars[i].split('=');
			if (decodeURIComponent(pair[0]) == variable) {
				return decodeURIComponent(pair[1]);
			};
		};
	};

	const $typeaheadDataset = $div.find('input.typeahead[name="dataset"]')
		// Recherche libre et filtre strict sur jeu de données
		.on('input', function() {
			qs['q'] = this.value;
		})
		.typeahead({
			source: (function() {
				var arr = [];
				{% for item in all_datasets %}
				arr.push({'id': '{{ item.id }}', 'name': '{{ item.name }}'});
				{% endfor %}
				return arr;
			})(),
			autoSelect: false,
			fitToElement: false,
			afterSelect: function(val) {
				qs['dataset'] = val.id;
			}
		})
		.val(getQueryVariable('q'));

	const $typeaheadOrganisation = $div.find('input.typeahead[name="organisation"]')
		// Recherche strict sur organisation
		.on('input', function() {
			qs['organisation'] = this.value;
		})
		.typeahead({
			source: (function() {
				var arr = [];
				{% for item in all_organisations %}
				arr.push({'id': '{{ item.id }}', 'name': '{{ item.name }}'});
				{% endfor %}
				return arr;
			})(),
			autoSelect: true,
			fitToElement: true,
			afterSelect: function(val) {
				qs['organisation'] = val.id;
			}
		})
		.typeahead('selectBy', 'id', getQueryVariable('organisation'));

	const $selectCategory = $div.find('select[name="category"]')
		// Recherche strict sur catégorie
		.on('change', function() {
			qs['category'] = this.value;
		});
	$selectCategory.val(getQueryVariable('category') || $selectCategory.find('option:first').val());

	const $checkPublished = $div.find('input[name="published"]')
		// Recherche strict sur le statut de publication des jeux de données
		.on('change', function() {
			qs['published'] = $(this).prop('checked');
		}).prop('checked', getQueryVariable('published') == 'true' ? true : false)


	const clear = function($target) {
		$target.is('input') && $target.val('');
		$target.is('select') && $target.val($target.find('option:first').val());
		qs[$target.prop('name')] = '';
		// Cas particulier de dataset et q..
		if ($target.prop('name') == 'dataset') {
			qs['q'] = '';
		};
	};

	$div.find('button[name="clear"]').click(function(e) {
		e.preventDefault();
		clear($(this).parent().siblings('input, select'));
	});

	$div.find('button[name="clear-all"]').click(function(e) {
		e.preventDefault();
		$div.find('input, select').each(function(i) {
			clear($(this));
		});
	});

	$div.find('button[name="submit"]').click(function(e) {
		e.preventDefault();

		var kvp = [];
		for (k in qs) {
			const k_ = encodeURI(k);
			const v_ = encodeURI(qs[k]);
			kvp = window.location.search.substr(1).split('&');
			var i = kvp.length; var x; while (i--) {
				x = kvp[i].split('=');
				if (x[0] == k_) {
					x[1] = v_;
					kvp[i] = x.join('=');
					break;
				};
			};
			if (i < 0) {
				kvp[kvp.length] = [k_, v_].join('=');
			};
		};
		window.location.search = kvp.join('&');
	});

});
</script>
