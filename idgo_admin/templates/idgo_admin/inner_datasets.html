{% load bootstrap3 %}

{% if messages %}
	{% for message in messages %}
		{% if message.tags == 'success' %}
			<div name='message-tags' class="alert alert-success" role="alert">{{ message | escape | safe }}</div>
		{% elif message.tags == 'error' %}
			<div name='message-tags' class="alert alert-danger" role="alert">{{ message | escape | safe }}</div>
		{% elif message.tags == 'info' %}
			<div name='message-tags' class="alert alert-info" role="alert">{{ message | escape | safe }}</div>
		{% endif %}
	{% endfor %}
{% endif %}

<div id="datasets">
	{% if awaiting_contributions %}
	<div class="alert alert-info">Demande(s) de contribution en attente de validation pour : {% for organization in awaiting_contributions %}<strong class="comma-separated-list">{{ organization.1 }}</strong>{% endfor %}</div>
	{% endif %}
	<div class="buttons-on-the-right-side">
		<a name="export-csv" class="btn btn-default">Exporter</a>
		<a name="add-dataset" class="btn btn-primary" href="{% url "idgo_admin:dataset" %}">Créer un nouveau jeu de données</a>
	</div>
	<div id="table-datasets" class="table-responsive"></div>
	<nav aria-label="Page navigation" style="text-align: center;">
		<ul id="table-datasets-paginator" class="pagination pagination-sm"></ul>
	</nav>
	<div class="buttons-on-the-right-side">
		<button name="view-ckan" class="btn btn-default">Ouvrir dans CKAN</button>
		<div class="btn-group">
			<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				Editer <span class="glyphicon glyphicon-triangle-bottom" style="top: 0.2em"></span>
			</button>
			<ul class="dropdown-menu dropdown-menu-right">
				<li><a role="button" name="edit-dataset" style="text-align: right;">Editer le jeu de données</a></li>
				<li><a role="button" name="mdedit-dataset" style="text-align: right;">Editer la fiche de métadonnées INSPIRE</a></li>
				<li role="separator" class="divider"></li>
				<li><a role="button" name="publish-dataset" style="text-align: right;">Publier le jeu de données</a></li>
			</ul>
		</div>
		<button name="delete-dataset" class="btn btn-danger" data-toggle="modal" data-target="#modal">Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>
	</div>
</div>

<script>
$(function() {
	var CKAN_URL = '{{ ckan_url }}';
	var DATASET_URL = '{% url "idgo_admin:dataset" %}';

	var DATASETS = {{ datasets | safe }};
	var DATASETS_CONTAINER = 'table-datasets';
	var DATASETS_METADATA = [
		{
			name: 'name',
			label: 'Nom',
			editable: false,
			datatype: 'string'
		}, {
			name: 'date_creation',
			label: 'Date de création',
			editable: false,
			datatype: 'string'
		}, {
			name: 'date_modification',
			label: 'Dernière modification',
			editable: false,
			datatype: 'string'
		}, {
			name: 'date_publication',
			label: 'Date de publication',
			editable: false,
			datatype: 'string'
		}, {
			name: 'organization',
			label: 'Organisation',
			editable: false,
			datatype: 'string'
		}, {
			name: 'published',
			label: 'Publié',
			editable: true,
			datatype: 'boolean'
		}, {
			name: 'is_inspire',
			label: 'INSPIRE',
			editable: true,
			datatype: 'boolean'
		}, {
			name: 'ckan_slug',
			label: '_HIDDEN',
			editable: false,
			datatype: 'string'
		}, {
			name: 'is_contributor',
			label: '_HIDDEN',
			editable: false,
			datatype: 'string'
		}, {
			name: 'id',
			label: '_HIDDEN',
			editable: false,
			datatype: 'integer'
		}
	];

	var resourcesGrid = new EditableGrid('Datasets', {pageSize: 20});

	$('#datasets button[name="view-ckan"]').on('click', function(e) {
		e.preventDefault();
		targetBlank(CKAN_URL + '/dataset/' + resourcesGrid.getRowValues(resourcesGrid.lastSelectedRowIndex)['ckan_slug']);
		e.stopPropagation();
	});

	$exportCSV = $('#datasets a[name="export-csv"]').on('click', function(e) {
		e.preventDefault();
		targetBlank('{% url "idgo_admin:export" %}?format=csv');
		e.stopPropagation();
	});

	if (DATASETS.length > 0) {
		activateButton($exportCSV);
	} else {
		deactivateButton($exportCSV);
	};

	$('#datasets button[name="delete-dataset"]')
		.on('click', function(e) {
			e.preventDefault();

			const $button = $('<button/>')
				.prop('type', 'button')
				.prop('class', 'btn btn-danger disabled')
				.prop('disabled', true)
				.text('Oui, supprimer définitivement ce jeu de données')
				.on('click', function(e) {
					e.preventDefault();
					closeAllModalDialog();
					$.ajax({
						type: 'DELETE',
						// success: function() {},
						url: DATASET_URL + '?id=' + resourcesGrid.getRowValues(resourcesGrid.lastSelectedRowIndex)['id']
					})
					.done(function(response, textStatus, jqXHR) {
						location.reload();
						// $modal.find('.modal-title').text('Information');
						// $modal.find('.modal-body').append(jqXHR.responseText);
						// $modal.modal('show');
					})
					.fail(function(jqXHR, textStatus, errorThrown) {
						location.reload();
						// $modal.find('.modal-title').text("L'opération a échouée");
						// $modal.find('.modal-body').append(jqXHR.responseText);
						// $modal.modal('show');
					});
					e.stopPropagation();
				});

			const $input = $('<input/>')
				.prop('type', 'text')
				.prop('class', 'form-control')
				.prop('placeholder', 'Nom du jeu de données à supprimer')
				.on('input', function(e) {
					if ($(this).val() === resourcesGrid.getRowValues(resourcesGrid.lastSelectedRowIndex)['name']) {
						$button.removeClass('disabled').prop('disabled', false);
					} else {
						$button.addClass('disabled').prop('disabled', true);
					};
				});

			$modal.find('.modal-title').text('Êtes-vous absolument sûr ?');

			$modal.find('.modal-body')
				.append('<p>Cette action est irreversible et supprimera <strong>définitivement</strong> le jeu de données ainsi que toutes les ressources qui lui sont attachées.</p>')
				.append(
					$('<form/>')
						.append(
							$('<div/>').prop('class', 'form-group')
								.append('<p>Pour confirmer, veuillez réécrire le nom du jeu de données à supprimer.</p>')
								.append($input))
						.append(
							$('<div class="buttons-on-the-right-side">')
								.append($button)
								.append('<button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>')));

			$modal.modal('show');

			e.stopPropagation();
		});

	$('#datasets a[name="edit-dataset"]')
		.on('click', function(e) {
			e.preventDefault();
			redirect(DATASET_URL + '?id=' + resourcesGrid.getRowValues(resourcesGrid.lastSelectedRowIndex)['id']);
			e.stopPropagation();
		});

	$('#datasets a[name="mdedit-dataset"]')
		.on('click', function(e) {
			e.preventDefault();
			redirect(DATASET_URL + '/' + resourcesGrid.getRowValues(resourcesGrid.lastSelectedRowIndex)['id']  + '/mdedit');
			e.stopPropagation();
		});

	let $publishDataset = $('#datasets a[name="publish-dataset"]')
		.on('click', function(e) {
			e.preventDefault();
			closeAllModalDialog();
			$.ajax({
				type: 'GET',
				// success: function() {},
				url: '{% url "idgo_admin:action" %}?id=' + resourcesGrid.getRowValues(resourcesGrid.lastSelectedRowIndex)['id'] + '&publish=toggle'
			})
			.done(function(response, textStatus, jqXHR) {
				// $modal.find('.close').remove();
				$modal.find('.modal-title').text('Information');
				$modal.find('.modal-body').append(jqXHR.responseText);
				$modal.modal('show');
			})
			.fail(function(jqXHR, textStatus, errorThrown) {
				// $modal.find('.close').remove();
				$modal.find('.modal-title').text("L'opération a échouée");
				$modal.find('.modal-body').append(jqXHR.responseText);
				$modal.modal('show');
			});
			e.stopPropagation();
		});

	resourcesGrid.initializeGrid = function() {
		let grid = resourcesGrid;
		let $buttons = $($('#' + this.currentContainerid).parent().get(0)).find('button,a[role="button"]');

		with (this) {
			tableRendered = function(containerId, className) {
				this.updatePaginator(grid);
				for (let i = 0; i < data.length; i ++) {
					const dataId = data[i].id;
					if (data[i].columns[8] == 'false') {
						$row = $(grid.tBody.rows[this.getRowIndex(data[i].id)]);
						$row.addClass('disabled');
					};
				};
			};
			rowSelected = function(pRowIdx, nRowIdx) {
				$(grid.getRow(pRowIdx)).removeClass('selected');
				$buttons.each(function() {
					deactivateButton($(this));
				});
				if (pRowIdx != nRowIdx) {
					$(grid.getRow(nRowIdx)).addClass('selected');
					$buttons.each(function() {
						activateButton($(this));
						if (!grid.getRowValues(nRowIdx)['is_inspire'] && this.name == 'mdedit-dataset') {
							deactivateButton($(this));
						};
					});
				};
				$publishDataset[0].innerHTML = (grid.getRowValues(nRowIdx)['published'] ? 'Dépublier' : 'Publier') + ' le jeu de données';
			};
			setCellRenderer('published', new CellRenderer({
				render: function(cell, value) {
					cell.style.textAlign = 'center';
					cell.style.width = '32px';
					cell.innerHTML = (value == true) ? '<span class="glyphicon glyphicon-ok"></span>' : '';
				}
			}));
			setCellRenderer('is_inspire', new CellRenderer({
				render: function(cell, value) {
					cell.style.textAlign = 'center';
					cell.style.width = '32px';
					cell.innerHTML = (value == true) ? '<span class="glyphicon glyphicon-ok"></span>' : '';
				}
			}));
			const DATE_FORMAT = 'dddd Do MMMM YYYY';
			setCellRenderer('date_creation', new CellRenderer({
				render: function(cell, value) {
					cell.innerHTML = value ? moment(value).format(DATE_FORMAT) : '-';
				}
			}));
			setCellRenderer('date_modification', new CellRenderer({
				render: function(cell, value) {
					cell.innerHTML = value ? moment(value).format(DATE_FORMAT) : '-';
				}
			}));
			setCellRenderer('date_publication', new CellRenderer({
				render: function(cell, value) {
					cell.innerHTML = value ? moment(value).format(DATE_FORMAT) : '-';
				}
			}));
		};
	};

	function updateDatasetsGrid(grid, containerId, metadata, data) {
		let $containerId = $('#' + containerId);
		let $parent = $($containerId.parent().get(0));
		$parent.find('div[role="alert"]not:div[name="message-tags"]').remove();
		$parent.find('button').each(function() {
			deactivateButton($(this));
		});
		if (data.length > 0) {
			grid.load({'metadata': metadata, 'data': data});
			grid.renderGrid(containerId, 'table table-striped table-bordered table-hover table-condensed');
			grid.initializeGrid();
			grid.refreshGrid();
			$containerId.show();
		} else {
			$containerId.hide();
		};

		const isContributor = {{ is_contributor | yesno:"true,false,none" }};

		if (!isContributor) {
			$parent.find('button.btn, a.btn').each(function() {
				deactivateButton($(this));
				$(this).hide();
			});
			$containerId.parent().before('<div role="alert" class="alert alert-warning"><p>Vous n\'êtes contributeur d\'aucune organisation. Pour devenir contributeur, vous devez <a href="{% url "idgo_admin:contribute" %}">ajouter une organisation à laquelle contribuer</a>.');
		};

		if (data.length == 0 && isContributor) {
			$parent.find('button.btn, a.btn').each(function() {
				deactivateButton($(this));
				$(this).hide();
			});
			$containerId.parent().after('<div role="alert" class="alert alert-warning"><p>Vous n\'avez aucun jeu de données. <a name="add-dataset" class="btn btn-primary" href="{% url "idgo_admin:dataset" %}">Créer un nouveau jeu de données</a> pour commencer.</p><div/>');
		};

	};

	updateDatasetsGrid(
		resourcesGrid,
		DATASETS_CONTAINER,
		DATASETS_METADATA,
		(function(data) {
			const m = [];
			for (let i = 0; i < data.length; i ++) {
				m.push({
					id: i,
					values: [
						data[i][1],  // name
						data[i][2],  // date_creation
						data[i][3],  // date_modification
						data[i][4],  // date_publication
						data[i][5],  // organization
						data[i][6],  // published
						data[i][7],  // is_inspire
						data[i][8],  // ckan_slug
						data[i][9],  // is_contributor
						data[i][0]   // id
					]
				});
			};
			return m;
		})(DATASETS)
	);
});
</script>
