{% load static %}
{% load bootstrap3 %}

{% block head_extras %}
<script src="{% static "libs/leaflet/leaflet.js" %}"></script>
<script src="{% static "libs/leaflet/leaflet-nontiledlayer.js" %}"></script>
<script src="{% static "libs/leaflet/leaflet-nontiledlayer-wms.js" %}"></script>
<link rel="stylesheet" href="{% static "libs/leaflet/leaflet.css" %}"/>
{% endblock head_extras %}

{% include "idgo_admin/alert_messages.html" %}

<template id="modal-body-template-on-success">
	<form>
		<div class="form-group">
			<label for="dataset" class="control-label">Jeu de données</label>
			<input type="text" class="form-control disabled" id="dataset" disabled>
		</div>
		<div class="form-group">
			<label for="resource" class="control-label">Ressource</label>
			<input type="text" class="form-control disabled" id="resource" disabled>
		</div>
		<div class="form-group">
			<label for="layer" class="control-label">Nom de la couche</label>
			<input type="text" class="form-control disabled" id="layer" disabled>
		</div>
		<div class="form-group">
			<label for="format" class="control-label">Format</label>
			<input type="text" class="form-control disabled" id="format" disabled>
		</div>
		<div class="form-group">
			<label for="submission" class="control-label">Système de coordonnées</label>
			<input type="datetime" class="form-control disabled" id="submission" disabled>
		</div>
		<div class="form-group">
			<label for="submission" class="control-label">Date de la demande</label>
			<input type="datetime" class="form-control disabled" id="submission" disabled>
		</div>
		<div class="form-group">
			<label for="submission" class="control-label">Aperçu</label>
			<div id="map" style="height: 238px;"></div>
		</div>
	</form>
	<div class="buttons-on-the-right-side">
		<a type="button" name="modify" class="btn btn-default">Modifier</a>
		<button type="button" name="again" class="btn btn-default">Relancer</button>
		<button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
	</div>
</template>

<template id="modal-body-template-on-error">
	<p>Une erreur s'est produite</p>
	<div class="buttons-on-the-right-side">
		<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
	</div>
</template>


<form>
	{% if is_admin %}

	{% endif %}
	<div name="actions" class="buttons-on-the-right-side">
		<a type="button" class="btn btn-primary" href="{% url "idgo_admin:extractor" %}">Nouvelle extraction</a>
	</div>
	<br/>
	<div class="table-responsive">
		<table id="extractor-dashboard" class="table table-striped table-bordered table-hover table-condensed">
			<tr>
				<th name="status">État <a name="sort" href="#"><span class="glyphicon glyphicon-sort" style="float: right;"></span></a></th>
				<th name="dataset">Jeu de données</th>
				<th name="resource">Ressource</th>
				<th name="submission">Demande <a name="sort" href="#"><span class="glyphicon glyphicon-sort" style="float: right;"></span></a></th>
				<th name="start">Début du traitement</th>
				<th name="stop">Fin de traitement</th>
				<th name="elapsed-time">Temps écoulé</th>
			</tr>
			{% for task in tasks %}
			<tr id="{{ task.uuid }}">
				<td name="status">{{ task.status }}</td>
				<td name="dataset"><a href="{% url "idgo_admin:dataset" %}?id={{ task.layer.resource.dataset.id }}">{{ task.layer.resource.dataset.name }}</a></td>
				<td name="resource"><a href="{% url "idgo_admin:resource" dataset_id=task.layer.resource.dataset.id %}?id={{ task.layer.resource.id }}">{{ task.layer.resource.name }}</a></td>
				<td name="submission">{{ task.submission_datetime | date:'d/m/Y H:i' }}</td>
				<td name="start">{% if task.start_datetime %}{{ task.start_datetime | date:'d/m/Y H:i' }}{% endif %}</td>
				<td name="stop">{% if task.stop_datetime %}{{ task.stop_datetime | date:'d/m/Y H:i' }}{% endif %}</td>
				<td name="elapsed-time">{{ task.elapsed_time }}</td>
			</tr>
			{% endfor %}
		<table>
	</div>
	<div name="actions" class="buttons-on-the-right-side">
	{# if is_admin #}
		<button type="button" name="open" class="btn btn-default disabled" disabled>Ouvrir</button>
		<button type="button" name="revoke" class="btn btn-default disabled" disabled>Révoquer</button>
		<div class="btn-group">
			<button type="button" class="btn btn-default dropdown-toggle disabled" data-toggle="dropdown" disabled>
				Prioriser <span class="glyphicon glyphicon-triangle-bottom" style="top: 0.2em"></span>
			</button>
			<ul class="dropdown-menu dropdown-menu-right">
				<li><a role="button" name="" class="disabled" style="text-align: right;" disabled>Priorité forte</a></li>
				<li><a role="button" name="" class="disabled" style="text-align: right;" disabled>Priorité faible</a></li>
			</ul>
		</div>
	{# else #}
		<button type="button" name="warn" class="btn btn-default disabled" disabled>Signaler une erreur</button>
	{# endif #}
	</div>
	{% if pagination.total > 1 %}
	<nav style="text-align: center;">
		<ul class="pagination pagination-sm">
			<nav style="text-align: center;">
				<ul id="paginator" class="pagination pagination-sm">
					{% if pagination.total > 2 %}
					<li {% if pagination.current == 1 %}class="disabled"{% endif %}>
						<a name="page" href="#" value="1">
							<span class="glyphicon glyphicon-fast-backward"></span>
						</a>
					</li>
					{% endif %}
					<li {% if pagination.current == 1 %}class="disabled"{% endif %}>
						<a name="page" href="#" value="{{ pagination.current|add:"-1" }}">
							<span class="glyphicon glyphicon-backward"></span>
						</a>
					</li>
					{% with ''|center:pagination.total as range %}
						{% for _ in range %}
					<li {% if forloop.counter == pagination.current %}class="active"{% endif %}>
						<a name="page" href="#" value="{{ forloop.counter }}">{{ forloop.counter }}</a>
					</li>
						{% endfor %}
					{% endwith %}
					<li {% if pagination.current == pagination.total %}class="disabled"{% endif %}>
						<a name="page" href="#" value="{{ pagination.current|add:"1" }}">
							<span class="glyphicon glyphicon-forward"></span>
						</a>
					</li>
					{% if pagination.total > 2 %}
					<li {% if pagination.current == pagination.total %}class="disabled"{% endif %}>
						<a name="page" href="#" value="{{ pagination.total }}">
							<span class="glyphicon glyphicon-fast-forward"></span>
						</a>
					</li>
					{% endif %}
				</ul>
			</nav>
		</ul>
	</nav>
	{% endif %}
</form>

<script>
$(function() {
	const $window = $(window);
	const $document = $(document);

	var qs = (function(items) {
		var kvp = {};
		for (var i = 0; i < items.length; i ++) {
			const kv = items[i].split('=');
			kvp[kv[0]]= kv[1];
		};
		return kvp;
	})($window[0].location.search.substring(1).split('&'));

	const reload = function(options) {
		var kvp = [];
		for (var k in qs) {
			if (k) {
				const key = encodeURI(k);
				const val = qs[k] ? encodeURI(qs[k]) : null;
				if (val) {
					kvp.push(key + '=' + val);
				}
			};
		};
		if (options.withHash == false) {
			$window[0].location.hash = '';
		};
		$window[0].location.search = kvp.join('&');
	};

	const openCmd = function(taskId) {
		$modalHourglass.one('show.bs.modal', function(e) {
			return
			$.ajax({
				type: 'GET',
				url: '{% url "idgo_admin:extractor_task" %}?id=' + taskId,
				success: function(data, status, xhr) {
					const $template = $('#modal-body-template-on-success');
					const $content = $($template.prop('content')).clone();

					for (const k in data) {
						$content.find('#' + k).val(data[k]);
					};

					$modal.find('.modal-title').text('Tâche « ' + taskId + ' »');
					$modal.find('.modal-body').append($content);
					$modal.find('a[name="modify"]').attr('href', '{% url "idgo_admin:extractor" %}?task=' + taskId);

					const map = L.map('map');

					const baseLayer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
						attribution: 'CartoDB',
					}).addTo(map);

					const wmsLayer = new L.NonTiledLayer.WMS('{% url "idgo_admin:ows_preview" %}', {
						format: 'image/png',
						layers: data['layer'],
						transparent: true
					}).addTo(map);

					// const footprintLayer = L.geoJSON(data.footprint, {
					// }).addTo(map);

					// const bounds = geojsonLayer.getBounds()
					const bounds = [[41.15, -9.86], [51.56, 10.38]];

					$modal
						.on('shown.bs.modal', function(e) {
							e.preventDefault();
							map.invalidateSize().fitBounds(bounds);
						})
						.modal('show');
				},
				error: function(xhr, statut, error) {
					const $template = $('#modal-body-template-on-error');
					const $content = $($template.prop('content')).clone();

					$modal.find('.modal-title').text('Tâche « ' + taskId + ' »');
					$modal.find('.modal-body').append($content);
					$modal.modal('show');
				}
			})
		}).modal('show');
	};

	const warnCmd = function(taskId) {
		console.log(taskId);

	};

	const revokeCmd = function(taskId) {
		console.log(taskId);

	};

	const $open = $('[name="open"]');
	const $warn = $('[name="warn"]');
	const $revoke = $('[name="revoke"]');

	const $table = $('#extractor-dashboard');

	$table.find('tr>th>a[name="sort"]')
		.click(function(e) {
			e.preventDefault();
			const $this = $(this);
			const targetValue = $this.parent().attr('name');
			qs['sortby'] = qs['sortby'] == targetValue ? '-' + targetValue : targetValue;
			reload({withHash: false});
		});

	$table.find('tr')
		.on('row.selected', function(e) {
			const $row = $(this);
			$row.prop('selected', true).addClass('selected');
			$('[name="actions"]').find('button, a[role="button"]').each(function() {
				$(this).prop('disabled', false).removeClass('disabled');
			});

			$open.off('click').on('click', function(e) {
				e.preventDefault();
				openCmd($row.prop('id'));
			});

			$warn.off('click').on('click', function(e) {
				e.preventDefault();
				warnCmd($row.prop('id'));
			});

			$revoke.off('click').on('click', function(e) {
				e.preventDefault();
				revokeCmd($row.prop('id'));
			});

		})
		.on('row.unselected', function(e) {
			const $row = $(this);
			$row.prop('selected', false).removeClass('selected');
			$('[name="actions"]').find('button, a[role="button"]').each(function() {
				$(this).prop('disabled', true).addClass('disabled');
			});
		})
		.on('click', function(e) {
			if (e.target.localName == 'a') {
				return;
			};
			const $that = $table.find('tr:selected');
			const $this = $(this);
			if ($that) {
				if ($this.index() != $that.index()) {
					$window[0].location.hash = $this.index();
				} else {
					$window[0].location.hash = '';
				};
			};
		});

	$('a[name="page"]')
		.click(function(e) {
			e.preventDefault();
			qs['page'] = $(this).attr('value');
			reload({withHash: false});
		});

	$window
		.bind('hashchange', function(e) {
			const rowId = $window[0].location.hash.substring(1);
			const $that = $table.find('tr:selected');
			const $this = rowId ? $table.find('tr:eq(' + rowId + ')') : undefined;
			if ($that) {
				$that.trigger('row.unselected');
				if ($this && ($this.index() != $that.index())) {
					$this.trigger('row.selected');
				};
			};
		})
		.trigger('hashchange');

});
</script>
