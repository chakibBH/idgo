{% extends "idgo_admin/base.html" %}

{% load bootstrap3 %}

{% block header %}{% endblock header %}
{% block nav %}{% endblock nav %}
{% block main %}
<div class="container">
	<div class="row">
		<div class="col-md-offset-2 col-md-8">
			<div class="panel">
				<div class="panel-heading">
					<h1 class="panel-title">Création d'un compte</h1>
				</div>
				<div class="panel-body">
					<form method="post" action="" enctype="multipart/form-data">
						{% csrf_token %}
						<div class="row">
							<div class="col-xs-12 col-sm-6">
								{% bootstrap_field form.first_name show_label=False %}
							</div>
							<div class="col-xs-12 col-sm-6">
								{% bootstrap_field form.last_name show_label=False %}
							</div>
						</div>
						<div class="row">
							<div class="col-xs-12 col-sm-4">
								{% bootstrap_field form.username show_label=False %}
							</div>
							<div class="col-xs-12 col-sm-8">
								{% bootstrap_field form.email show_label=False %}
							</div>
						</div>
						<div class="row">
							<div class="col-xs-3">
								{% bootstrap_field form.phone show_label=False %}
							</div>
						</div>
						<div class="row">
							<div class="col-xs-12 col-sm-6">
								{% bootstrap_field form.password1 show_label=False %}
							</div>
							<div class="col-xs-12 col-sm-6">
								{% bootstrap_field form.password2 show_label=False %}
							</div>
						</div>
						<div id="collapse-one" class="collapse in">
							<p>Sélectionnez dans la liste ci-dessous votre organisation</p>
							<div class="row">
								<div class="col-sm-9">
									{% bootstrap_field form.organisation show_label=False %}
								</div>
							</div>
							<p>Si celle-ci n'est pas dans la liste, vous pouvez <a name="open" type="button">indiquer une nouvelle organisation</a>. </p>
						</div>
						<div id="collapse-two" class="collapse">
							<div class="well">
								<button name="close" type="button" class="close" data-dismiss="alert" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
								<h4>Formulaire de création d'une organisation</h4>
								<br />
								<p>Toute demande de création d'organisation est soumise à l'administrateur du site pour validation. </p>
								<br />
								<div class="row">
									<div class="col-sm-8">
										{% bootstrap_field form.new_orga show_label=False %}
									</div>
								</div>

								<div class="row">
									<div class="col-sm-6">
										<label>Contact</label>
										<div class="row">
											<div class="col-sm-12">
												{% bootstrap_field form.address show_label=False %}
											</div>
										</div>
										<div class="row">
											<div class="col-sm-6">
												{% bootstrap_field form.postcode show_label=False %}
											</div>
											<div class="col-sm-6">
												{% bootstrap_field form.city show_label=False %}
											</div>
										</div>
									</div>
									<div class="col-sm-6">
										<div class="row">
											<div class="col-sm-12">
												{% bootstrap_field form.logo %}
											</div>
										</div>
									</div>
								</div>
								<div class="row">
									<div class="col-sm-2 col-md-4">
										{% bootstrap_field form.org_phone show_label=False %}
									</div>
								</div>
								<div class="row">
									<div class="col-sm-5 col-md-4">
										{% bootstrap_field form.org_email show_label=False %}
									</div>
								</div>
								<div class="row">
									<div class="col-sm-5 col-md-4">
										{% bootstrap_field form.website show_label=False %}
									</div>
								</div>
								<div class="row">
									<div class="col-sm-12">
										{% bootstrap_field form.description show_label=False %}
									</div>
								</div>
								<div class="row">
									<div class="col-sm-6">
										{% bootstrap_field form.jurisdiction %}
									</div>
								</div>
								<div class="row">
									<div class="col-sm-6">
										{% bootstrap_field form.organisation_type %}
									</div>
								</div>
								<div class="row">
									<div class="col-sm-6">
										{% bootstrap_field form.license %}
									</div>
								</div>
								<div class="buttons-on-the-right-side">
									<button name="close" type="button" class="btn btn-default" data-dismiss="alert" aria-label="Close">Fermer</button>
								</div>
							</div>
						</div>
						<div>
							{% bootstrap_field form.contributor show_label=False %}
							{% bootstrap_field form.referent show_label=False %}
						</div>
						<br />
						<div class="buttons-on-the-right-side">
							<a class="btn btn-default" href="{% url "idgo_admin:signIn" %}">Revenir</a>
							<button type="submit" class="btn btn-primary">Valider</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
$(function() {

	const $inputContribution = $('input[name="{{ form.contributor.name }}"]');
	const $inputReferent = $('input[name="{{ form.referent.name }}"]').change(function() {
		this.checked ? $inputContribution.prop('checked', true).prop('disabled', true) : $inputContribution.prop('checked', true).prop('disabled', false);
	});

	const toggleInputVisibility = function() {
		var selected = parseInt($selectOrganization.val());
		var value = {{ form.organisation.value | yesno:'true,false,NaN' }};

		selected = isNaN(selected) ? null : selected;
		value = isNaN(value) ? null : value;

		if ((!selected || value === selected) && $collapseOne.hasClass('in')) {
			$inputContribution.parent().hide();
			$inputContribution.prop('checked', false);
			$inputReferent.parent().hide();
			$inputReferent.prop('checked', false);
		} else {
			$inputReferent.is(':checked') ? $inputContribution.prop('checked', true) : $inputContribution.prop('checked', false);
			$inputContribution.parent().show();
			$inputReferent.parent().show();
		};
	};

	const $selectOrganization = $('select[name="organisation"]')
		.ready(toggleInputVisibility)
		.change(toggleInputVisibility);

	const $collapseOne = $('#collapse-one').collapse({toggle: false})
		.on('hidden.bs.collapse', function() {
			{% if is_membership %}
			$inputReferent.prop('checked', false).trigger('change');
			{% else %}
			$inputReferent.prop('checked', true).trigger('change');
			{% endif %}

			$selectOrganization.selectedIndex = 0;
			$('#collapse-one select').each(function(i) {
				$(this)[0].selectedIndex = 0;
			});
			toggleInputVisibility();
		});

	const $collapseTwo = $('#collapse-two').collapse({toggle: false})
		.on('hide.bs.collapse', function() {
			$inputReferent.prop('checked', false).trigger('change');
			$selectOrganization.find('option[value="{{ form.organisation.value | yesno:"true,false,NaN" }}"]').prop('selected', true);
			$('#collapse-two input').each(function(i) {
				$(this).val('');
			});
		})
		.on('hidden.bs.collapse', function() {
			toggleInputVisibility();
		});

	const toggleCollpase = function() {
		$collapseOne.collapse('toggle');
		$collapseTwo.collapse('toggle');
	};

	$collapseOne.find('[name="open"]').click(toggleCollpase);
	$collapseTwo.find('[name="close"]').click(toggleCollpase);

	{% if form.new_orga.value %} toggleCollpase(); {% endif %}
});
</script>
{% endblock main %}
