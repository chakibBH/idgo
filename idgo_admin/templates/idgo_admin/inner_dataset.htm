{% load bootstrap3 %}

{% if message and message.status == 'success' %}
<div class="alert alert-success" role="alert">{{ message.text | safe }}</div>
{% elif message and message.status == 'failure' %}
<div class="alert alert-danger" role="alert">{{ message.text | safe }}</div>
{% endif %}

<form name="dataset" method="post" action="">
	{% csrf_token %}
	{% bootstrap_field form.name %}
	{% bootstrap_field form.description %}
	{% bootstrap_field form.geocover %}
	{% bootstrap_field form.update_freq %}

	{% for widget in form.date_creation %}
	<div class="form-group">
		<label class="control-label" for="{{ widget.attrs.id }}">{{ widget.name }}</label>
		<input class="form-control date start"  name="{{ widget.name }}" id="{{ widget.attrs.id }}" type="text" {% if widget.value != None %} value="{{ widget.value|stringformat:'s' }}" {% endif %} {% if widget.attrs.required == True %} required="" {% endif %} ></input>
		<script>;$('#{{ widget.attrs.id }}').datepicker();</script>
	</div>
	{% endfor %}

	{% for widget in form.date_modification %}
	<div class="form-group">
		<label class="control-label" for="{{ widget.attrs.id }}">{{ widget.name }}</label>
		<input class="form-control"  name="{{ widget.name }}" id="{{ widget.attrs.id }}" type="text" {% if widget.value != None %} value="{{ widget.value|stringformat:'s' }}" {% endif %} {% if widget.attrs.required == True %} required="" {% endif %} ></input>
		<script>;$('#{{ widget.attrs.id }}').datepicker();</script>
	</div>
	{% endfor %}

	{% for widget in form.date_publication %}
	<div class="form-group">
		<label class="control-label" for="{{ widget.attrs.id }}">{{ widget.name }}</label>
		<input class="form-control"  name="{{ widget.name }}" id="{{ widget.attrs.id }}" type="text" {% if widget.value != None %} value="{{ widget.value|stringformat:'s' }}" {% endif %} {% if widget.attrs.required == True %} required="" {% endif %} ></input>
		<script>;$('#{{ widget.attrs.id }}').datepicker();</script>
	</div>
	{% endfor %}

	{% bootstrap_field form.organisation %}
	{% bootstrap_field form.licences %}
	{% bootstrap_field form.owner_email %}

	{% for widget in form.keywords %}
	<div class="form-group">
		<label class="control-label" for="{{ widget.attrs.id }}">{{ widget.name }}</label>
		<input class="form-control" name="{{ widget.name }}" id="{{ widget.attrs.id }}" type="text"></input>
	</div>
	<script>

	{% if widget.value %}
		console.log("{{ widget.value }}")
	{% endif %}

	function extractor(query) {
		var result = /([^,]+)$/.exec(query);
		if(result && result[1]) {
			return result[1].trim();
		};
		return '';
	};
	$('#{{ widget.attrs.id }}').typeahead({
		source: {{ tags | safe }},
		updater: function(item) {
			return this.$element.val().replace(/[^,]*$/,'') + ' ' + item + ', ';
		},
		matcher: function (item) {
			var tquery = extractor(this.query);
			if (!tquery) {
				return false;
			};
			return ~item.toLowerCase().indexOf(tquery.toLowerCase())
		},
		highlighter: function (item) {
			var query = extractor(this.query).replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&')
			return item.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
				return '<strong>' + match + '</strong>';
			});
		}
	});
	</script>
	{% endfor %}

	<div class="form-group">
		<label for="categories">Catégories</label></br>
		<div id="categories" class="btn-group" data-toggle="buttons">
			{% for category in form.categories %}
			<label for="{{ category.id_for_label }}" class="btn">
				{{ category.tag }}
				<span class="badge">{{ category.choice_label }}</span>
			</label>
			{% empty %}
			<p>Aucune catégorie n'est disponible.</p>
			{% endfor %}
		</div>
	</div>
	{% bootstrap_field form.is_inspire %}
	{% bootstrap_field form.published %}
	<div class="buttons-on-the-right-side">
		{% if not dataset_id %}
		<button type="submit" name="next" class="btn btn-default">Enregistrer et continuer</button>
		{% endif %}
		<button type="submit" name="save" class="btn btn-default">Enregistrer</button>
		<a class="btn btn-default" href="{% url "idgo_admin:home" %}">Annuler</a>
	</div>
</form>
<script>
$('form[name="dataset"] input[checked=""], form[name="dataset"] input[checked="checked"]').each(function() {
	$('label[for="' + this.id + '"]').addClass('active');
});
</script>
