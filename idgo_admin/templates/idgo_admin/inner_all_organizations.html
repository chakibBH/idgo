{% load bootstrap3 %}

{% include "idgo_admin/alert_messages.html" %}

<template id="organization_well_template">
	<div>
		<ul class="nav nav-tabs" role="tablist">
			<li role="presentation" class="active">
				<a href="#info" aria-controls="info" role="tab" data-toggle="tab">Informations générales</a>
			</li>
			<li role="presentation">
				<a href="#members" aria-controls="members" role="tab" data-toggle="tab">Utilisateurs</a>
			</li>
			<li role="presentation">
				<a href="#me" aria-controls="me" role="tab" data-toggle="tab">Moi et l'organisation</a>
			</li>
		</ul>
		<div class="tab-content">
			<div role="tabpanel" class="tab-pane active" id="info">
				<div class="tab-pane-content">
					<div class="row">
						<div class="col-sm-8">
							<h3 name="name"></h4>
						</div>
						<div class="col-sm-4">
							<img name="logo" alt="" width="100%"></img>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-5">
							<div class="row">
								<div class="col-md-12">
									<span name="address"></span>
								</div>
							</div>
							<div class="row">
								<div class="col-md-12">
									<span name="postcode"></span> <span name="city"></span>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-3">
							<span class="glyphicon glyphicon-earphone" aria-hidden="true"></span> <span name="phone"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> <span name="email"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<span class="glyphicon glyphicon-globe" aria-hidden="true"></span> <a target="_blank" name="website"></a></span>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12">
							<p name="description"></p>
						</div>
					</div>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane" id="members">
				<div class="tab-pane-content">
					<div id="table-members" class="table-responsive"></div>
					<nav aria-label="Page navigation" style="text-align: center;">
						<ul id="table-members-paginator" class="pagination pagination-sm"></ul>
					</nav>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane" id="me">

			</div>
		</div>
	</div>
</template>


<div id="allorganizations" style="height: 5OOpx;">
	<div class="row">
		<div class="col-md-4">
			{% if organizations|length > 10 %}
			<div class="input-group">
				<input name="organization" type="text" class="form-control typeahead" placeholder="Rechercher l'organisation...">
				<span class="input-group-btn">
					<button type="button" class="btn btn-primary">
						<span class="glyphicon glyphicon-search"></span>
					</button>
				</span>
			</div>
			{% elif organizations|length > 1 and organizations|length <= 10 %}
			<select name="organization" class="form-control">
				{% for entry in organizations %}
				<option value="{{ entry }}">{{ entry }}</option>
				{% endfor %}
			</select>
			{% elif organizations|length == 1 %}
				{% for k, v in organizations.items %}
			<input name="organization" class="form-control" type="text" value="{{ k }}" disabled />
				{% endfor %}
			{% else %}
			<div class="alert alert-info" role="alert">Aucune organisation n'est disponible</div>
			{% endif %}
			<div class="btn-group-vertical btn-block scrolling-box" style="min-height: 1OO%;" data-toggle="buttons">
				{% for item in organizations %}
				<label for="id_organization_{{ item.pk }}" class="btn btn-radio">
					{% if item.contributeur %}<span class="badge badge-circle"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></span>{% endif %}
					{% if item.subordinates %}<span class="badge badge-circle"><span class="glyphicon glyphicon-certificate" aria-hidden="true"></span></span>{% endif %}
					{% if item.rattachement %}<span class="badge badge-circle"><span class="glyphicon glyphicon-user" aria-hidden="true"></span></span>{% endif %}
					{{ item.name }}
					<input type="radio" name="organizations" value="{{ item.pk }}" id="id_organization_{{ item.pk }}"></input>
				</label>
				{% endfor %}
			</div>
		</div>
		<div class="buttons-on-the-right-side">
			<a href='{% url "idgo_admin:create_organization" %}' class="btn btn-primary">Ajouter une organisation</a>
		</div>
		<div id='organization_well' class="col-md-8 well" style="min-height: 1OO%;"></div>
	</div>
</div>

<script>
$(function() {

	const tableId = 'table-members';
	const grid = new EditableGrid('Members', {pageSize: 10});

	grid.initializeGrid = function() {
		with (this) {
			tableRendered = function(tableId, className) {
				rowSelected(-1, -1);
				updatePaginator(this);
			}.bind(this);
			rowSelected = function(pRowIdx, nRowIdx) {
				const data = this.getRowValues(nRowIdx);
				USERNAME = data.username;
				$(grid.getRow(pRowIdx)).removeClass('selected');
				// deactivateButton($button);
				if (pRowIdx != nRowIdx && !data.is_referent) {
					$(this.getRow(nRowIdx)).addClass('selected');
					activateButton($button);
				};
			}.bind(this);
			const booleanRender = function(cell, value) {
				cell.style.textAlign = 'center';
				cell.style.width = '32px';
				cell.innerHTML = (value == true) ? '<span class="glyphicon glyphicon-ok"></span>' : '';
			};
			setCellRenderer('is_member', new CellRenderer({render: booleanRender}));
			setCellRenderer('is_contributor', new CellRenderer({render: booleanRender}));
			setCellRenderer('is_referent', new CellRenderer({render: booleanRender}));
		};
	};


	$('a[data-toggle="tab"][href="#members"]').on('hide.bs.tab', function(e) {
		rowId = grid.lastSelectedRowIndex;
		grid.rowSelected(rowId, rowId);
	});


	const displayOrganisation = function(data) {
		const $template = $('#organization_well_template');
		const $content = $($template.prop('content')).clone();
		const $organizationWell = $('#organization_well').empty()


		for (const k in data) {
			$content.find('[name="' + k + '"]').text(data[k]);
		};

		$organizationWell.append($content);

		let $table = $('#' + tableId);
		let $parent = $($table.parent());

		if (data.members.length > 0) {
			grid.load({
				'metadata': [
					{
						name: 'username',
						label: 'Utilisateur',
						editable: false,
						datatype: 'string'
					}, {
						name: 'full_name',
						label: 'Nom',
						editable: false,
						datatype: 'string'
					}, {
						name: 'is_member',
						label: 'Membre',
						editable: false,
						datatype: 'boolean'
					}, {
						name: 'is_contributor',
						label: 'Contributeur',
						editable: false,
						datatype: 'boolean'
					}, {
						name: 'is_referent',
						label: 'Référent technique',
						editable: false,
						datatype: 'boolean'
					}, {
						name: 'datasets_count',
						label: 'Nombre de jeux de données',
						editable: false,
						datatype: 'integer'
					}, {
						name: 'id',
						label: '_HIDDEN',
						editable: false,
						datatype: 'integer'
					}
				],
				'data': (function(data) {
					const m = [];
					for (let i in data) {
						m.push({
							id: i,
							values: [
								data[i].username,
								data[i].full_name,
								data[i].is_member,
								data[i].is_contributor,
								data[i].is_referent,
								data[i].datasets_count,
								data[i].profile_id
							]
						});
					};
					return m;
				})(data.members)
			});
			grid.renderGrid(tableId, 'table table-striped table-bordered table-hover table-condensed');
			grid.initializeGrid();
			grid.refreshGrid();
			$table.show();
		} else {
			// $table.hide();
		};

		{% for item in subordinates %}
		if (data['id'] == {{ item.0 }}) {
			$('#organization_well .tab-pane#info').append('<div class="buttons-on-the-right-side"><a href="{% url "idgo_admin:edit_organization" id=item.0 %}" name="edit" type="button" class="btn btn-default">Editer</a></div>');
		};
		{% endfor %}
	};

	const getOrganization = function(id) {
		$.ajax({
			url: '/organization/' + id,
			success: function(data, status, xhr) {
				displayOrganisation(data);
			},
			error : function(resultat, statut, erreur){
				$('.tab-pane#info').empty();
				$('.tab-pane#info').append("Impossible d'obtenir les informations");
			}
		});
	};

	$('.typeahead[name="organization"]').typeahead({
		source: (function() {
			let arr = [];
			{% for item in organizations %}
			arr.push({id: {{ item.pk }}, 'name': '{{ item.name }}'})
			{% endfor %}
			return arr;
		})(),
		autoSelect: true,
		afterSelect: function(val) {
			selectRowByDataId(val.id);
		}
	});

	$('.typeahead button').click(function(e) {
		alert('TODO');
	});

	const $organizations = $('input[type=radio][name=organizations]').change(function(e) {
		window.location.hash = this.value;
		getOrganization(this.value);
	});

	const selectRowByDataId = function(value) {
		$organizations.val([value]);
		const $entry = $('input[type=radio][name=organizations][value=' + value + ']').parent();
		const $container = $('div.scrolling-box');
		$container.animate({
			scrollTop: $entry.offset().top - $container.offset().top + $container.scrollTop() - 7
		}, 303, undefined, function() {
			getOrganization(value);
		});
	};

	$(window).bind('hashchange', function(e) {
		selectRowByDataId(window.location.hash.substring(1));
	});
	selectRowByDataId(window.location.hash.substring(1));  // TODO->Avant de charger la page

});
</script>
