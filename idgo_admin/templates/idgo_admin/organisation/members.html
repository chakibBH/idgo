<div id="members">
	{% if organisation.members|length == 0 %}
	<div role="alert" class="alert alert-info">Aucun utilisateur.</div>
	{% else %}
	<div class="table-responsive">
		<table class="board table table-striped table-bordered table-hover table-condensed">
			<thead>
				<tr>
					<th name="username">Utilisateur</th>
					<th name="full_name">Nom</th>
					<th name="is_member">Membre</th>
					<th name="is_contributor">Contributeur</th>
					<th name="is_referent">Référent</th>
					{% if user.profile.is_crige_admin %}
					<th name="is_crige_member">CRIGE</th>
					{% endif %}
					<th name="datasets_count">Jeux de données</th>
				</tr>
			</thead>
			<tbody>
				{% for member in organisation.members %}
				<tr id="{{ member.pk }}" name="{{ member.username }}">
					<td name="username">{{ member.username }}</td>
					<td name="full_name">{{ member.full_name }}</td>
					<td name="is_member" style="text-align: center;">
						{% if member.is_member %}
						<span class="glyphicon glyphicon-ok"></span>
						{% endif %}
					</td>
					<td name="is_contributor" style="text-align: center;">
						{% if member.is_contributor %}
						<span class="glyphicon glyphicon-ok"></span>
						{% endif %}
					</td>
					<td name="is_referent" style="text-align: center;">
						{% if member.is_referent %}
						<span class="glyphicon glyphicon-ok"></span>
						{% endif %}
					</td>
					{% if user.profile.is_crige_admin %}
					<td name="is_crige_member" style="text-align: center;">
						{% if member.is_crige_member %}
						<span class="glyphicon glyphicon-ok"></span>
						{% endif %}
					</td>
					{% endif %}
					<td name="datasets_count">{{ member.datasets_count }}</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>
<div class="buttons-on-the-right-side">
	{% if user.profile.is_crige_admin %}
	<!-- <button role="button" name="send-mail-to-crige-member" class="btn btn-default">Envoyer un e-mail aux membres CRIGE</button> -->
	{% endif %}
	<button role="button" name="ckan-card" class="btn btn-default">Ouvrir la fiche Ckan</button>
	<div class="btn-group">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			Supprimer un statut <span class="glyphicon glyphicon-triangle-bottom" style="top: 0.2em"></span>
		</button>
		<ul class="dropdown-menu dropdown-menu-right">
			<li>
				<a role="button" name="delete-member" style="text-align: right;" data-toggle="modal" data-target="#modal">Supprimer le statut de membre</a>
			</li>
			<li>
				<a role="button" name="delete-contributor" style="text-align: right;" data-toggle="modal" data-target="#modal">Supprimer le statut de contributeur</a>
			</li>
			<li>
				<a role="button" name="delete-referent" style="text-align: right;" data-toggle="modal" data-target="#modal">Supprimer le statut de référent technique</a>
			</li>
		</ul>
	</div>
</div>
<script>
$(function() {

	const $div = $('#members');

	const $ckanUserCard = $($div.find('button[name="ckan-card"]'));
	const $btnGroup = $($div.find('.btn-group'));
	const $dropdownButton = $($div.find('.btn-group>button.dropdown-toggle'));
	const $deleteMember = $($btnGroup.find('a[name="delete-member"]'));
	const $deleteContributor = $($btnGroup.find('a[name="delete-contributor"]'));
	const $deleteReferent = $($btnGroup.find('a[name="delete-referent"]'));

	deactivateButton($ckanUserCard);
	deactivateButton($dropdownButton);
	deactivateButton($deleteMember);
	deactivateButton($deleteReferent);
	deactivateButton($deleteContributor);

	const $table = $div.find('table');
	$table.find('tr')
		.on('row.selected', function(e) {
			const $row = $(this);
			const id = $row.attr('id');
			if (!id) {
				return;
			};
			$row.prop('selected', true).addClass('selected');

			$ckanUserCard.off('click').on('click', function(e) {
				targetBlank('{{ ckan_url }}/user/' + data.username);
			});

			$deleteMember.off('click').on('click', function(e) {
				openModalDelete(ORGANISATION_ID, data.username, 'members');
			});

			$deleteContributor.off('click').on('click', function(e) {
				openModalDelete(ORGANISATION_ID, data.username, 'contributors');
			});

			$deleteReferent.off('click').on('click', function(e) {
				openModalDelete(ORGANISATION_ID, data.username, 'referents');
			});

		})
		.on('row.unselected', function(e) {
			const $row = $(this);
			$row.prop('selected', false).removeClass('selected');

			deactivateButton($deleteMember);
			deactivateButton($deleteMember);
			deactivateButton($deleteContributor);
			deactivateButton($deleteReferent);
			deactivateButton($dropdownButton);

		})
		.on('click', function(e) {

		});

	grid.rowSelected = function(pRowIdx, nRowIdx) {
		$(grid.getRow(pRowIdx)).removeClass('selected');

		deactivateButton($deleteMember);
		deactivateButton($deleteMember);
		deactivateButton($deleteContributor);
		deactivateButton($deleteReferent);
		deactivateButton($dropdownButton);

		const data = grid.getRowValues(nRowIdx);

		if (nRowIdx > -1) {

			$ckanUserCard.off('click').on('click', function(e) {
				targetBlank('{{ ckan_url }}/user/' + data.username);
			});

			$deleteMember.off('click').on('click', function(e) {
				openModalDelete(ORGANISATION_ID, data.username, 'members');
			});

			$deleteContributor.off('click').on('click', function(e) {
				openModalDelete(ORGANISATION_ID, data.username, 'contributors');
			});

			$deleteReferent.off('click').on('click', function(e) {
				openModalDelete(ORGANISATION_ID, data.username, 'referents');
			});

			if (pRowIdx != nRowIdx) {
				$(this.getRow(nRowIdx)).addClass('selected');
				activateButton($ckanUserCard);
				if (!data.is_referent && (isReferent()) || {{ is_admin | yesno:'true,false,null' }})  {
					data.is_member ? activateButton($deleteMember) : deactivateButton($deleteMember);
					data.is_contributor ? activateButton($deleteContributor) : deactivateButton($deleteContributor);
					data.is_referent ? activateButton($deleteReferent) : deactivateButton($deleteReferent);
					(data.is_member || data.is_contributor || data.is_referent) ? activateButton($dropdownButton) : deactivateButton($dropdownButton);
				};
			};

		};
	};
});
</script>
{% endif %}
