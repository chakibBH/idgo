{% load bootstrap3 %}

{% if messages %}
	{% for message in messages %}
		{% if message.tags == 'success' %}
			<div name='message-tags' class="alert alert-success" role="alert">{{ message | escape | safe }}</div>
		{% elif message.tags == 'error' %}
			<div name='message-tags' class="alert alert-danger" role="alert">{{ message | escape | safe }}</div>
		{% elif message.tags == 'info' %}
			<div name='message-tags' class="alert alert-info" role="alert">{{ message | escape | safe }}</div>
		{% endif %}
	{% endfor %}
{% endif %}

<br/>
<form method="post" action="" enctype="multipart/form-data">
	{% csrf_token %}
	{% if pform.organisation.field.widget.is_hidden == False %}
		{% include "idgo_admin/inner_manageorganization.html" %}
	{% else %}
	<div class="alert alert-info"><a href="{% url "idgo_admin:organizations" %}">En attente de rattachement</a></div>
	{% endif %}
	<div class="buttons-on-the-right-side">
		<a class="btn btn-default" href="{% url "idgo_admin:organizations" %}">Revenir</a>
		<button type="submit" class="btn btn-default">Valider les changements</button>
	</div>
</form>
<script>
$(function() {
	var $contributionRequested = $('input[name="contribution_requested"]').parent();
	var contribs = {{ contribs|safe }};
	var pending = {{ pending|safe }};
	var pendingIds = [];
	for (var i = 0; i < pending.length; i ++) {
		pendingIds.push(pending[i][0]);
	};
	var isContributor = function() {
		var val = parseInt($('select[name="organisation"]').val());
		var $alert = $contributionRequested.siblings('.alert');
		if ($alert) {
			$alert.remove()
		};
		if (val && contribs.indexOf(val) == -1 && pendingIds.indexOf(val) == -1) {
			$contributionRequested.show();
		} else if (val && contribs.indexOf(val) == -1 && pendingIds.indexOf(val) > -1) {
			$contributionRequested.hide();
			$contributionRequested.before('<div class="alert alert-info">Demande de contribution en attente de validation pour : {% for organization in pending %}<strong class="comma-separated-list">{{ organization.1 }}</strong>{% endfor %}</div>');
		} else {
			$contributionRequested.hide();
		};
	};

	$('select[name="organisation"]').change(isContributor);

	var $collapseOne = $('#collapse-one')
		.collapse({
			toggle: false
		})
		.on('hidden.bs.collapse', function() {
			$('#collapse-one select').each(function(i) {
				// $(this)[0].selectedIndex = 0;
				$contributionRequested.show();
			});
		});
	var $collapseTwo = $('#collapse-two')
		.collapse({
			toggle: false
		})
		.on('hidden.bs.collapse', function() {
			$('#collapse-two input').each(function(i) {
				$(this).val('');
				$contributionRequested.hide();
			});
		});

	function tggl() {
		$collapseOne.collapse('toggle');
		$collapseTwo.collapse('toggle');
	};

	$('#add-organization').click(tggl);
	$('#collapse-two .close').click(tggl);

	$contributionRequested.hide();
	{% if pform.new_orga.value %} tggl(); {% endif %}

	$('select[name="organisation"]').ready(isContributor);

});

</script>
