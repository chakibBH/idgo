{% load bootstrap3 %}

{% include "idgo_admin/alert_messages.html" %}

<template id="progressbar_template">
	<div class="container-progress">
		<span class="glyphicon glyphicon-send"></span>
		<div class="progress">
			<div class="progress-bar progress-bar-striped" role="progressbar"></div>
		</div>
		<div class="progress-status">-</div>
	</div>
</template>

<form method="post" action="" enctype="multipart/form-data">
	<div class="buttons-on-the-right-side">
		{% if resource_ckan_id %}
		<a class="btn btn-default" target="_blank" href="{{ ckan_url }}/dataset/{{ dataset_ckan_slug }}/resource/{{ resource_ckan_id }}">Ouvrir dans CKAN</a>
		{% endif %}
	</div>
	<br/>
	{% csrf_token %}
	<div class="row">
		<div class="col-xs-12">
			{% if mode %}
				<div class="well">
				{% if mode == 'up_file' %}
					{% bootstrap_field form.up_file %}
				{% elif mode == 'dl_url' %}
					{% bootstrap_field form.dl_url %}
					<div class="row">
						<div class="col-xs-5 col-sm-5 col-md-4">
							{% bootstrap_field form.synchronisation %}
						</div>
					</div>
					<div class="row">
						<div class="col-xs-5 col-sm-5 col-md-4">
							{% bootstrap_field form.sync_frequency show_label=False %}
						</div>
					</div>
				{% elif mode == 'referenced_url' %}
					{% bootstrap_field form.referenced_url %}
				{% endif %}
				</div>
			{% else %}
			<ul class="nav nav-tabs" name="data-selector" role="tablist">
				<li role="presentation">
					<a name="up_file" href="#up_file" aria-controls="up_file" role="tab" data-toggle="tab">Téléverser un fichier</a>
				</li>
				<li role="presentation">
					<a name="dl_url" href="#dl_url" aria-controls="dl_url" role="tab" data-toggle="tab">Télécharger depuis une URL</a>
				</li>
				<li role="presentation">
					<a name="referenced_url" href="#referenced_url" aria-controls="referenced_url" role="tab" data-toggle="tab">Référencer une URL</a>
				</li>
			</ul>
			<div class="well tab-content" name="data-selector-panel">
				<div role="tabpanel" class="tab-pane" id="up_file">
					{% bootstrap_field form.up_file show_label=False %}
				</div>
				<div role="tabpanel" class="tab-pane" id="dl_url">
					<p>Veuillez indiquer l'URL d'un fichier à télécharger : </p>
					{% bootstrap_field form.dl_url show_label=False %}
					<div class="row">
						<div class="col-xs-5 col-sm-5 col-md-4">
							{% bootstrap_field form.synchronisation %}
						</div>
					</div>
					<div class="row">
						<div class="col-xs-5 col-sm-5 col-md-4">
							{% bootstrap_field form.sync_frequency show_label=False %}
						</div>
					</div>
				</div>
				<div role="tabpanel" class="tab-pane" id="referenced_url">
					<p>Veuillez indiquer l'URL d'un jeu de données à référencer : </p>
					{% bootstrap_field form.referenced_url show_label=False %}
				</div>
			</div>
			{% endif %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			{% bootstrap_field form.name %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			{% bootstrap_field form.description %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-4">
			{% bootstrap_field form.lang %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-4">
			{% bootstrap_field form.format_type %}
		</div>
	</div>
	<div class="row">
		<div class="col-xs-4">
			{% bootstrap_field form.data_type %}
		</div>
	</div>
	<hr />
	<div class="row">
		<div class="col-xs-8">
			{% bootstrap_field form.restricted_level %}
		</div>
	</div>
	<div class="collapse" id="permitted-users">
		<div class="well">
			{% bootstrap_field form.profiles_allowed %}
		</div>
	</div>
	<div class="collapse" id="permitted-organizations">
		<div class="well">
			{% bootstrap_field form.organisations_allowed %}
		</div>
	</div>
	<br />
	{# if group_crige #}
	<div class="well">
		<div class="row">
			<div class="col-xs-12">
				{% bootstrap_field form.geo_restriction %}
			</div>
		</div>
		<div class="row">
			<div class="col-xs-12">
				{% bootstrap_field form.extractable %}
			</div>
		</div>
		<div class="row">
			<div class="col-xs-12">
				{% bootstrap_field form.ogc_services %}
			</div>
		</div>
	</div>
	<br />
	{# endif #}
	<div class="row">
		<div class="col-xs-12">
			<p>* Les champs marqués d'un astérisque sont obligatoires.</p>
		</div>
	</div>
	<br />
	<div class="buttons-on-the-right-side">
		<a class="btn btn-default" href="{% url "idgo_admin:dataset" %}?id={{ dataset_id }}#resources">Annuler</a>
		<button type="submit" name="continue" value="continue" class="btn btn-primary">Enregistrer et continuer les modifications</button>
		<button type="submit" name="save" value="save" class="btn btn-primary">Enregistrer</button>
	</div>
</form>

<script>
$(function() {

	$('button[name="continue,save"]').prop('type', 'button');

	const $permittedUsers = $('#permitted-users').collapse({toggle: false}).on('hidden.bs.collapse', function() {
		$('#collapse-restriction input').each(function(i) {
			$(this).val('');
		});
	});

	const $permittedOrganizations = $('#permitted-organizations').collapse({toggle: false}).on('hidden.bs.collapse', function() {
		$('#collapse-restriction input').each(function(i) {
			$(this).val('');
		});
	});

	const getAccessSelectedOption = function($this) {
		const value = $this.find('option:selected').val();
		if (value === '2') {
			$permittedOrganizations.collapse('hide');
			$permittedUsers.collapse('show');
		}
		else if (value === '4') {
			$permittedUsers.collapse('hide');
			$permittedOrganizations.collapse('show');
		}
		else {
			$permittedUsers.collapse('hide');
			$permittedOrganizations.collapse('hide');
		};
	};

	$selectAccess = $('select[name="{{ form.restricted_level.name }}"]').change(function() {
		getAccessSelectedOption($(this));
	});

	const disableSyncFrequency = function(value) {
		$('select[name="{{ form.sync_frequency.name }}"]').prop('disabled', value);
	};

	$inputSynchronisation = $('input[name="{{ form.synchronisation.name }}"]').change(function(e) {
		e.preventDefault();
		disableSyncFrequency(!this.checked);
	});
	{% if form.synchronisation.value %}
	disableSyncFrequency(false);
	{% endif %}

	$(document).on('change', ':file', function() {
		const $this = $(this);
		const $files = $this.get(0).files;
		const count = $files ? $files.length : 1;
		if (count == 1) {  // TODO count > 1
			$('input[name="{{ form.name.name }}"]').val($files[0].name);
			if ($files[0].type && $files[0].extension) {
				$('select[name="{{ form.format_type.name }}"] option').each(function() {
					if ($files[0].extension.toLowerCase() == this.text.toLowerCase()) {
						$('select[name="{{ form.format_type.name }}"] option[value="' + this.value + '"]').prop('selected', true);
					};
				});
			};
		};
	});

	const $input = $('input[type="file"]').change(function(e) {
		if ($input.val().length > 0) {
			// TODO
		};
	});

	$(document).ready(function() {
		getAccessSelectedOption($('select[name="{{ form.restricted_level.name }}"]'));
	});

	$('button[type="submit"]').click(function(e) {
		e.preventDefault();

		const $form = $('form');
		const modeName = $('ul.nav[name="data-selector"] li.active a').attr('name');

		{% if mode %}
			{% if mode == 'up_file' %}
		const ajaxMode = $form.find('input[name="{{ form.up_file.name }}"][type="file"]').val() ? true : false;
			{% elif mode == 'referenced_url' %}
		const ajaxMode = true;
			{% else %}
		const ajaxMode = false;
			{% endif %}
		{% else %}
		const ajaxMode = (
			(
				modeName == '{{ form.dl_url.name }}'  && $form.find('input[name="{{ form.dl_url.name }}"][type="url"]').val()
			) || (
				modeName == '{{ form.up_file.name }}' && $form.find('input[name="{{ form.up_file.name }}"][type="file"]').val())
			) ? true : false;
		{% endif %}

		if (ajaxMode) {

			window.scrollTo(0, 0);

			const data = new FormData($form[0]);
			data.append('ajax', true);
			data.append(this.name, true);

			const $progressBar = $($('#progressbar_template').prop('content')).clone();
			$modal.addClass('progress-bar-modal');
			$modal.find('.modal-header').remove();
			$modal.find('.modal-body').append($progressBar);
			$modal.modal('show').one('shown.bs.modal', function(e) {
				e.preventDefault();
				$.ajax({
					type: 'POST',
					url: '{% url "idgo_admin:resource" dataset_id=dataset_id %}?id={{ resource_id }}',
					data: data,
					contentType: false,
					processData: false,
					success: function(data, status, xhr) {
						$('.container-message').empty();
						$('.help-block').remove();
						$('.progress-bar-on-top .progress-bar').css('display', 'none').css('width', '0%');

						$modal.one('hidden.bs.modal', function(e) {
							e.preventDefault();
							if (xhr.status == 302) {
								return window.location.href = xhr.getResponseHeader('Location');
							} else if (xhr.status == 201) {
								return window.location.href = xhr.getResponseHeader('Content-Location');
							} else if (xhr.status == 200) {
								try {
									data = JSON.parse(data);
								} catch (e) {
									data = undefined;
								};
								if (data.error) {
									for (const key in data.error) {
										const val = data.error[key].join();
										if (key == '__all__') {
											$('.container-message').append('<div name="message-tags" class="alert alert-danger" role="alert"><span class="glyphicon glyphicon-ban-circle" aria-hidden="true"></span>' + val + '</div>');
										} else {
											if (key == '{{ form.up_file.name }}') {
												$('#id_' + key).closest('.ezdz-dropzone').after('<div class="help-block">' + val + '</div>').closest('.form-group').addClass('has-error');
											} else {
												$('#id_' + key).after('<div class="help-block">' + val + '</div>').closest('.form-group').addClass('has-error');
											};
										};
									};
								};
							};
						}).modal('hide');
					},
					error: function(xhr) {
						$('.container-message').empty();
						$('.help-block').remove();
						$('.progress-bar-on-top .progress-bar').css('display', 'none').css('width', '0%');
						$modal.one('hidden.bs.modal', function(e) {
							e.preventDefault();
							if (xhr.status == 500) {
								$('.container-message').append('<div name="message-tags" class="alert alert-danger" role="alert"><span class="glyphicon glyphicon-ban-circle" aria-hidden="true"></span>Une erreur s\'est produite, si le problème persiste veuillez contacter l\'administrateur du site</div>');
							};
						}).modal('hide');
					},
					xhr: function() {
						const $progressBar = $('.progress-bar');
						const $progressStatus = $('.progress-status');
						const xhr = new window.XMLHttpRequest();

						let value;
						xhr.upload.addEventListener('loadstart', function(e) {
							value = 0;
						}, false);
						xhr.upload.addEventListener('progress', function(e) {
							if (e.lengthComputable) {
								value = Math.round(e.loaded / e.total * 100);
								$progressBar.css('width', value + '%');
								if (value < 100) {
									$progressStatus.html('<strong>' + value + ' %</strong>');
								} else {
									$progressStatus.html('Le fichier est envoyé');
									setTimeout(function () {
										$progressStatus.html('En attente de la réponse du serveur');
										$progressBar.addClass('active');
									}, 1234);
								};
							};
						}, false);
						// xhr.upload.addEventListener('loadend', function(e) {
						// 	$progressBar.addClass('active');
						// 	$progressStatus.html('En attente de la réponse du serveur');
						// }, false);
						xhr.upload.addEventListener('timeout', function(e) {
							$progressBar.removeClass('active');
							$progressStatus.html('Erreur : Impossible de joindre le serveur. Veuillez réessayer plus tard.');
						});

						return xhr;
					},
				});
			});
		} else {
			$form.append($('<input/>').prop('name', this.name).hide());
			$form.submit();
			e.stopPropagation();
		};

	});

});
</script>
